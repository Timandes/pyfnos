name: DingTalk Notification

on:
  issues:
    types: [opened, edited, closed, reopened]
  pull_request:
    types: [opened, edited, closed, reopened, review_requested]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.sender.type == 'User'  # åªé€šçŸ¥ç”¨æˆ·ï¼Œå¿½ç•¥æœºå™¨äºº
    steps:
      - name: Send to DingTalk
        run: |
          if [ "${{ github.event_name }}" == "issues" ]; then
            EVENT_TYPE="Issue"
            ACTION="${{ github.event.action }}"
            TITLE="${{ github.event.issue.title }}"
            URL="${{ github.event.issue.html_url }}"
            AUTHOR="${{ github.event.issue.user.login }}"
          else
            EVENT_TYPE="Pull Request"
            ACTION="${{ github.event.action }}"
            TITLE="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
          fi

          # æ ¹æ®åŠ¨ä½œç±»å‹è®¾ç½®emoji
          case "$ACTION" in
            opened)
              EMOJI="ğŸ†•"
              ;;
            edited)
              EMOJI="âœï¸"
              ;;
            closed)
              EMOJI="âœ…"
              ;;
            reopened)
              EMOJI="ğŸ”„"
              ;;
            review_requested)
              EMOJI="ğŸ‘€"
              ;;
            *)
              EMOJI="ğŸ“Œ"
              ;;
          esac

          # æ„é€ é’‰é’‰æ¶ˆæ¯
          MESSAGE="{\n            \"msgtype\": \"markdown\",\n            \"markdown\": {\n              \"title\": \"GitHub ${EVENT_TYPE} ${ACTION}\",\n              \"text\": \"## ${EMOJI} GitHub ${EVENT_TYPE} ${ACTION}\\n\\n**ä»“åº“**: ${{ github.repository }}\\n\\n**æ ‡é¢˜**: ${TITLE}\\n\\n**æ“ä½œäºº**: ${AUTHOR}\\n\\n[æŸ¥çœ‹è¯¦æƒ…](${URL})\"\n            }\n          }"

          # å‘é€åˆ°é’‰é’‰
          curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "$MESSAGE"